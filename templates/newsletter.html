<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ newsletter.title }}</title>
    <style>
{{ styles }}
    </style>
</head>
<body class="theme-{{ selected_theme }}">
    <main class="newsletter-container" role="main" aria-label="Daily Newsletter">
        <header class="header" role="banner">
            <h1 aria-label="Newsletter title">ðŸ“° {{ newsletter.title }}</h1>
            <p class="date">{{ (newsletter.generated_at or "") }}</p>
        </header>

        {% if newsletter.metrics %}
        <section class="stats" aria-label="Newsletter metrics">
            <div class="stats-item">
                <span class="stats-number">{{ newsletter.metrics.total_stories }}</span>
                <span>News Stories</span>
            </div>
            <div class="stats-item">
                <span class="stats-number">{{ newsletter.metrics.stories_by_category|length }}</span>
                <span>Categories</span>
            </div>
            <div class="stats-item">
                <span class="stats-number">{{ '%.2f'|format(newsletter.metrics.generation_time) }}</span>
                <span>Generation Time (s)</span>
            </div>
        </section>
        {% endif %}

        {% if newsletter.executive_summary %}
        <section class="executive-summary" aria-label="Executive summary">
            <h2>Executive Summary</h2>
            <p>{{ newsletter.executive_summary|safe }}</p>
        </section>
        {% endif %}

        {% for category in newsletter.categories %}
        <section class="category" aria-labelledby="category-{{ loop.index }}">
            <h2 id="category-{{ loop.index }}" class="category-title">{{ category.name }}</h2>

            {% for subcategory in category.subcategories %}
            <details class="subcategory" open>
                <summary class="subcategory-title">{{ subcategory.name }}</summary>
                {% if subcategory['intro'] %}
                <p class="subcategory-intro">{{ subcategory['intro']|safe }}</p>
                {% endif %}

                {% for item in subcategory['items'] %}
                <article class="news-item" aria-label="News item">
                    <h3 class="news-title">{{ item.title }}</h3>
                    <p class="news-summary">{{ item.summary }}</p>
                    <footer class="news-sources" aria-label="Sources">
                        {% set sources = item.all_sources or [] %}
                        {% if sources %}
                            {% for source in sources %}
                                <p class="source-item">ðŸ“§ {{ source.sender }} - {{ source.subject }}</p>
                            {% endfor %}
                        {% endif %}
                        {% if item.source_urls %}
                            {% for url in item.source_urls %}
                                <p class="source-item">ðŸ”— <a href="{{ url }}" class="source-link">{{ url }}</a></p>
                            {% endfor %}
                        {% endif %}
                    </footer>
                </article>
                {% endfor %}
            </details>
            {% endfor %}
        </section>
        {% endfor %}

        <footer class="footer" role="contentinfo">
            <p>Generated by News Tracker AI on {{ newsletter.generated_at }}</p>
            <p>This newsletter aggregates news from your personal email accounts.</p>
        </footer>
    </main>
</body>
</html>
